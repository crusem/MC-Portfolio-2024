---
title: "Predict heroin overdose events to better allocate prevention resources"
substitle: "Using a Geospatial Risk Prediciton Model as a Sighting Mechanism for Harm Reduction Vending Machines in Cincinnati, Ohio"
author: "Marissa Cruse & Alyssa Felix Arreola"
date: "2023-12"
output: 
  html_document:
    code_folding: hide
---
## Introduction
### Heroin and Drug Overdoses in Cincinnati and Harm Reduction Measures
The United States faces a large opioid crisis, where opioid misuses and deaths continue to increase. In 2017, Ohio experienced the second highest overdose rates in the United States, where the city of Cincinnati experienced a 50% rise since 2015 [1]. In understanding this, Cincinnati was one of the 12 hotspots in Ohio for highest per capita rates of fatal overdose between 2010 and 2017 [1]. Heroin overdose incidences, in connection, remain high, leading to public health issues such as HIV and need-borne diseases. 

To decrease these high overdose rates, harm reduction vending machines (HRVMs) have been used as an accessible method for those who use drugs for risk reduction and prevention resources including naloxone, fentanyl testing strips, sterile syringes, tourniquets, and bandages. According to the Center for Disease Control and Prevention (CDC), HRVMs are a lower-barrier mode of accessing harm reduction, in place of harm reduction programs or reach sites that have harm reduction resources [2]. Carocole, an HIV/AIDs service organization in Cincinnati, has brought the HRVM to this city, in partnership with Interact for Health. The machine was located outside of Caracole’s building on Hamilton Avenue and made accessible 24/7 [3]. In order to use the machine, users had to complete an anonymous survey, in which they were given an access code to use for the vending machine that was good for 90 days. 

Through enrolling, users are given access to harm reduction counselors that offer additional information on HIV and hepatitis C prevention and testing information, local housing programs, counseling, substance use disorder medical treatment and prenatal care. Within the vending machine, each person can dispense two injection doses, two nasal spray doses of naloxone, a container for disposing sharp objects, a safer injection kit, a smoking kit, a personal protective equipment kit, a safer sex kit, a pregnancy test and a box of bandages from the machine every seven days [3].

In the installation of the vending machine until December 2022, users reported that 960 overdoses were reversed using naloxone from the machine. In this event, while the national overdose deaths increased by 15 percent, Hamilton County, in Cincinnati, decreased by 10 percent [3]. While there are many variables to consider, the University of Cincinnati’s, Daniel Arendt, Doctor of Pharmacy, expressed that he believes this vending machine made a large impact [3]. Within its first year, the machine dispensed 3,360 doses of naloxone and 10,155 fentanyl test strips, with 911 users, 16 percent of whom had never used harm reduction services before [3]. 

### How can this model predict future heroin overdoses?
Our analysis uses a geospatial risk model. This is a regression model, where the dependent variable is the occurrence of overdoses. The predictions in using this model will forecast the risk of overdose occurring in specific locations. 

In predicting overdose in Cincinnati, this model functions under the hypothesis that overdose risk is a function of exposure to different geospatial risk and protective factors, such as Police Calls related to drug activity and locations of vacant lots.

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r message=FALSE, warning=FALSE}
library(patchwork)
library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat.explore)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(classInt)   
library(dplyr)
library(tigris)
library(tidygeocoder)
library(ggmap)
library(tidyr)
library(spatstat)
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

```{r message=FALSE, warning=FALSE}
project_crs = ('EPSG:3735')
library(showtext)

font_add("Times New Roman", regular = "times.ttf", bold = "timesbd.ttf", italic = "timesi.ttf", bolditalic = "timesbi.ttf")

showtext_auto()

map_theme <- function() {
  theme_minimal() +
    theme(
      axis.line = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(size = 20, hjust = 0, face = "bold"),  
      plot.subtitle = element_text(size = 14, face = "italic")
    )
}
```

## Data Wrangling
The analysis uses overdose, drug related police calls, vacant lot locations, and demographic data from the ACS. 

In a study conducted by Greg Gonsalves and other colleagues, a spatial temporal analysis was conducted, using a Bayesian space-time Poisson regression model to understand the associations of features such as built environment and demographic characteristics and number of calls within block groups [1]. This study found that suspected heroin-related emergency calls were positively associated with the proportion of male population, population aged 35-49 and negatively associated with median household income, and the proportion of the population with a bachelor’s degree or higher. 

```{r Loading the Boundary of Cincinnati, message=FALSE, warning=FALSE, results = 'hide'}
boundary <- st_read("C:/Users/cruse/Downloads/Cincinnati_City_Boundary/Cincinnati_City_Boundary.shp") 
```

```{r Creating a Fishnet of Cincinnati, message=FALSE, warning=FALSE}
fishnet <- 
  st_make_grid(boundary,
               cellsize = 500, 
               square = TRUE) %>%
  .[boundary] %>%           
  st_sf() %>%
  mutate(uniqueID = 1:n())
```

```{r Loading & Cleaning Overdose Data, message=FALSE, warning=FALSE}
overdose <- read.socrata("https://data.cincinnati-oh.gov/resource/w46w-g9g7.json") %>%
  filter(!is.na(latitude_x) & !is.na(longitude_x))%>%
  filter(year(create_time_incident) == 2021) %>%
  mutate(legend = "overdose_incidents")
write.csv(overdose, file = "C:/Users/cruse/OneDrive/Desktop/PPA/overdose", row.names = FALSE)
rm(overdose)
```

```{r Loading & Cleaning Overdose Data Pt. 2, message=FALSE, warning=FALSE}
overdose <- read.csv("C:/Users/cruse/OneDrive/Desktop/PPA/overdose") %>% 
  st_as_sf(coords = c("longitude_x", "latitude_x"), remove = FALSE) %>%
  st_set_crs('EPSG:4326') %>%
  dplyr::select(geometry, legend)

overdose <- st_transform(overdose, crs = project_crs)
```


```{r Loading & Cleaning Drug Related Police Call Data, message=FALSE, warning=FALSE}
drug_calls <- read.socrata("https://data.cincinnati-oh.gov/resource/gexm-h6bt.json")%>%
  filter(!is.na(latitude_x) & !is.na(longitude_x))%>%
  filter(incident_type_id %in% c("DRUG", "DISORD") & year(create_time_incident) == 2021) %>%
  mutate(legend = "drug_calls") 

write.csv(drug_calls, file = "C:/Users/cruse/OneDrive/Desktop/PPA/drug_calls", row.names = FALSE)
rm(drug_calls)
```
```{r Loading & Cleaning Drug Related Police Call Data Pt. 2, message=FALSE, warning=FALSE}
drug_calls <- read.csv("C:/Users/cruse/OneDrive/Desktop/PPA/drug_calls") %>% 
  st_as_sf(coords = c("longitude_x", "latitude_x"), remove = FALSE) %>%
  st_set_crs('EPSG:4326') %>%
  dplyr::select(geometry, legend)

drug_calls <- st_transform(drug_calls, crs = project_crs)
```


```{r Loading & Cleaning Vacant Lot Data, message=FALSE, warning=FALSE}
vacant <- read.csv("C:/Users/cruse/Downloads/vacantbldgs (1).csv")
vacant$complete_address <- paste(vacant$ADDRESS, ", Cincinnati, OH", sep = " ")

register_google(key = "AIzaSyAZRaWpH-a6aM-Ac7Ln9nObYNPlasBn3Yg")
vacant <- vacant %>%
  tidygeocoder::geocode(
    address = complete_address,
    method = "osm"
  )

write.csv(vacant, file = "C:/Users/cruse/OneDrive/Desktop/PPA/vacant", row.names = FALSE)
rm(vacant)
```

```{r Loading & Cleaning Vacant Lot Data Pt. 2, message=FALSE, warning=FALSE}
vacant <- read.csv("C:/Users/cruse/OneDrive/Desktop/PPA/vacant")
vacant <- vacant[complete.cases(vacant[c("lat", "long")]), ]
vacant <- st_as_sf(vacant, coords = c("long", "lat"))%>%
  st_set_crs('EPSG:4326') 
vacant <- st_transform(vacant, crs = project_crs)
vacant <- vacant %>%
  mutate(legend = "vacant")%>%
  dplyr::select(geometry, legend)
```


```{r Loading & Cleaning Cincinnati Demographic Data, message=FALSE, warning=FALSE, results = 'hide'}
cincinnati_demographic_data <-
  get_acs(geography = "tract", variables = c("B01001_001E","B01001A_001E","B06011_001", "B15002_014E", "B15002_001E", "B01001_010E", "B01001_011E", "B01001_012E"), 
          year = 2021, state=39, county=061, geometry=T, output = "wide") %>%
  st_set_crs(4326)  %>%
  rename(TotalPop = B01001_001E,
         NumberWhites = B01001A_001E,
         Median_Income = B06011_001E,
         Bachelors_Pop = B15002_014E,
         Tot_Pop_edu = B15002_001E,
         age_35_39 = B01001_010E,
         age_40_44 = B01001_011E,
         age_45_49 = B01001_012E) %>%
  mutate(percentWhite = NumberWhites / TotalPop,
         percentBachelors = Bachelors_Pop/Tot_Pop_edu,
         percentNonWhite = (1 - percentWhite),
        age_35_49 = age_35_39 + age_40_44 + age_45_49)
cincinnati_demographic_data <- st_transform(cincinnati_demographic_data, crs = project_crs)
cincinnati_demographic_data <- st_intersection(cincinnati_demographic_data, boundary)

cincinnati_demographic_data <- cincinnati_demographic_data %>%
  dplyr::select(geometry, percentBachelors, age_35_49, Median_Income)
```


## Exploratory Analysis & Vizualizations
### Creating a Fishnet of Cincinnati
To represent the spatial trend of overdose incidents in Cincinnati, OH, we aggregate point level data into a lattice of grid cells, or a fishnet of the boundary of Cincinnati. 

```{r Plotting the Fishnet of Cincinnati, message=FALSE, warning=FALSE}
ggplot() +
  geom_sf(data = fishnet, color = "black", fill = "white") +
  labs(title = "Fishnet of Cincinnati",
       caption = "Source: City of Cincinnati") +
  theme_void() +
  map_theme()
```

### Observing Densisity of Overdoses in Cincinnati, Ohio
```{r Plotting Density of Overdoses in Cincinnati, message=FALSE, warning=FALSE, results = 'hide'}
ggplot() + 
  geom_sf(data = boundary, fill = "darkgrey", color = alpha("white", 0)) +
  stat_density2d(data = data.frame(st_coordinates(overdose)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_viridis() +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title = "Density of Overdoses in Cincinnati, Ohio", 
       subtitle = "Overdoses Incidents in 2021",
       caption = "Source: City of Cincinnati") +
  theme_void()  +
  map_theme() +
  theme(
    legend.title = element_blank(),
    legend.text = element_blank(),
    plot.title = element_text(hjust = 0)
  )
```

### Joining Overdoses to the Fishnet
Using overdose data from the City of Cincinnati, the overdose data is joined to fishnet data to sum each overdose incident by grid lattice cell. A 'cvID' column is created for cross-validation and a 'uniqueID'column is created to assign an ID to each grid cell. 
```{r Joining Overdoses to the Fishnet & Plotting, message=FALSE, warning=FALSE}
overdose_net <- 
  dplyr::select(overdose) %>% 
  mutate(countOD = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countOD = replace_na(countOD, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 96), size=nrow(fishnet), replace = TRUE))

ggplot() +
  geom_sf(data = overdose_net, aes(fill = countOD)) +
  scale_fill_viridis() +
  labs(title = "Count of Overdoses in Cincinnati by Fishnet",
       subtitle = "Overdose Incidents in 2021",
       caption = "Source: City of Cincinnati") +
  map_theme()+
  theme(
    legend.title = element_blank(),
    legend.text = element_blank()
  )
```

### Joining Predictors to the Fishnet
The risk factors, vacant lots, drug related police calls, and demographic data by census tract, is wrangled to the fishnet. These fishnets give an idea of how our risk factors are distributed spatially. 

```{r Joining Predictors to the Fishnet, message=FALSE, warning=FALSE}
vars_net <- 
  rbind(vacant, drug_calls) %>%
  st_join(., fishnet, join=st_within) %>%
  st_drop_geometry() %>%
  group_by(uniqueID, legend) %>%
  summarize(count = n()) %>%
    full_join(fishnet) %>%
    spread(legend, count, fill=0) %>%
    st_sf() %>%
    dplyr::select(-`<NA>`) %>%
    na.omit() %>%
    ungroup()

vars_net <- st_join(vars_net, cincinnati_demographic_data)


```

```{r Plotting Risk Factors to the Fishnet, message=FALSE, warning=FALSE}
vars_net.long <- 
  gather(vars_net, Variable, value, -geometry, -uniqueID)

vars <- unique(vars_net.long$Variable)
mapList <- list()
titles <- c("Drug Related Police Calls", "Vacant Lots", "Percent With Bachelors or Higher", "Count of Population Age 35-49", "Median Income", "Vacant Lots NN", "Drug Related Police Calls NN")
for(i in vars){
  mapList[[i]] <- 
    ggplot() +
      geom_sf(data = filter(vars_net.long, Variable == i), aes(fill=value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title= titles[which(vars ==i)]) +
      theme_void()+
      theme(
      axis.line = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(size = 12, hjust = 0),  # Adjust legend title size
        legend.key.size = unit(.8, "lines"))}

combined_plots <- wrap_plots(mapList, ncol = 3) + plot_annotation(title = "Risk Factors by Fishnet", theme = theme(plot.title = element_text(size = 16, face = "bold")))

# Print or display the combined plots
print(combined_plots)
```

## Feature Engineering
Using a nearest neighbor function, columns 'vacant.nn' and 'drug_calls.nn' are created to calculate the average nearest neighbor distance. These values will tell us the average average distance from one point (one vacant lot, or one drug related police call), to the closest 3 other points. This provides an idea of the spatial arrangement of the points. 
```{r Calculating Nearest Neighbors, message=FALSE, warning=FALSE}
vars_coordinates <- (st_coordinates(st_centroid(vars_net)))
vacant_coordinates <- st_coordinates(vacant)
drugcall_coordinates <- st_coordinates(drug_calls)

vars_net <-
  vars_net %>%
    mutate(
      vacant.nn = nn_function(vars_coordinates, vacant_coordinates, k=3),
      drug_calls.nn = nn_function(vars_coordinates, drugcall_coordinates, k=3))
```

```{r Plotting Nearest Neighbors for Vacant Lots and Drug Related Police Calls, message=FALSE, warning=FALSE}
vars_net.long.nn <- 
  dplyr::select(vars_net, ends_with(".nn")) %>%
    gather(Variable, value, -geometry)

vars <- unique(vars_net.long.nn$Variable)
mapList <- list()

for (i in vars) {
  title_text <- switch(i,
    "vacant.nn" = "Vacant Lots NN",
    "drug_calls.nn" = "Drug Related Police Calls NN",
  )

  mapList[[i]] <- 
    ggplot() +
    geom_sf(data = filter(vars_net.long.nn, Variable == i), aes(fill = value), colour = NA) +
    scale_fill_viridis(name = "") +
    labs(title = title_text,
         caption = "Source: City of Cincinnati") +
    theme_void()+
    theme(
      axis.line = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.subtitle = element_text(face = "italic"), 
      plot.title = element_text(size = 12, hjust = 0)
    )
}

combined_plots1 <- wrap_plots(mapList, ncol = 2) + plot_annotation(title = "Nearest Neighbor Factors by Fishnet", theme = theme(plot.title = element_text(size = 16, face = "bold")))

print(combined_plots1)
```

## Understanding the Spatial Process of Overdoses in Cincinnati
Spatial Autocorrelation refers to the tendency of similar values to occur near each other in geographic space. Understanding spatial autocorrelation is important because it reveals patters in spatial data. To test for spatial autocorrelation for our variables, we use a Local Moran's I test. 

Looking at this information spatially, conclusions regarding the spatial arrangement of the overdose data can be drawn. The Local Moran's I plot depicts the level of spatial autocorrelation and autocorrelation in the overdose data. Grid cells with a higher P-Value are grid cells with higher counts of overdoses. Lastly, significant hot-spots are depicted as areas with a P-Value less than 0.05.
```{r Creating the Final Net, message=FALSE, warning=FALSE}
vars_net$uniqueID <- as.character(vars_net$uniqueID)

final_net <-
  left_join(overdose_net, st_drop_geometry(vars_net), by="uniqueID") 
final_net.nb <- poly2nb(as_Spatial(final_net), queen=TRUE)
final_net.weights <- nb2listw(final_net.nb, style="W", zero.policy=TRUE)
```

```{r Calculating and Plotting Local Morans I Statistics for Overdoses, message=FALSE, warning=FALSE}
final_net.localMorans <- 
  cbind(
    as.data.frame(localmoran(final_net$countOD, final_net.weights)),
    as.data.frame(final_net)) %>% 
    st_sf() 

final_net.localMorans<- final_net.localMorans%>%
      dplyr::select(Overdose_Count = countOD, 
                    Local_Morans_I = Ii, 
                    P_Value = `Pr(z != E(Ii))`) %>%
      mutate(Significant_Hotspots = ifelse(P_Value <= 0.05, 1, 0)) %>%
      gather(Variable, Value, -geometry)
  
vars <- unique(final_net.localMorans$Variable)
varList <- list()

for(i in vars){title_text2 <- switch(i,

    "P_Value" = "P - Value",
    "Local_Morans_I" = "Local Moran's I",
    "Overdose_Count" = "Overdose Count",
    "Significant_Hotspots" = "Significant Hotspots"
  )
  varList[[i]] <- 
    ggplot() +
      geom_sf(data = filter(final_net.localMorans, Variable == i), 
              aes(fill = Value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title = title_text2,
         caption = "Source: City of Cincinnati") +
    theme_void()+
    theme(
      axis.line = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.subtitle = element_text(face = "italic"), 
      plot.title = element_text(size = 12, hjust = 0), #
        legend.key.size = unit(.5, "lines")
    )}

combined_plots2 <- wrap_plots(varList, ncol = 2) + plot_annotation(title = "Local Moran's I Statistics, Overdoses", theme = theme(plot.title = element_text(size = 16, face = "bold")))

print(combined_plots2)
```

```{r Creating Dummy Variables to Classify Signficance Level & Measurieng Distance to Nearest Significant CLuster, message=FALSE, warning=FALSE}
final_net <-
  final_net %>% 
  mutate(overdose.isSig = 
           ifelse(localmoran(final_net$countOD, 
                             final_net.weights)[,5] <= 0.0000001, 1, 0)) %>%
  mutate(overdose.isSig.dist = 
           nn_function(st_coordinates(st_centroid(final_net)),
                       st_coordinates(st_centroid(
                         filter(final_net, overdose.isSig == 1))), 1))
```


## Correlation Tests 
Running correlation tests will allow for some variables to be eliminated from our model. Predictors with an r absolute value of less than 0.15 will be eliminated from the model. After running these correlation tests, the final model that includes risk factors only will include drug related police calls, vacant lots, drug related police calls nearest neighbors, vacant lots nearest neighbors.The final model including spatial autocorrelation variables will also use these risk factors.Predictors related to the demographics of Cincinnati have been eliminated. 
```{r Running Correlation Tests, message=FALSE, warning=FALSE}
correlation.long <-
  st_drop_geometry(final_net) %>%
    dplyr::select(-uniqueID, -cvID) %>%
    gather(Variable, Value, -countOD)

correlation.cor <-
  correlation.long %>%
    group_by(Variable) %>%
    summarize(correlation = cor(Value, countOD, use = "complete.obs"))
    
ggplot(correlation.long, aes(Value, countOD)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.cor, aes(label = paste("r =", round(correlation, 2))),
            x = -Inf, y = Inf, vjust = 1.5, hjust = -0.1) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  facet_wrap(~Variable, ncol = 3, scales = "free") +
  labs(
    title = "Overdose Count as a Function of Risk factors",
    x = "Risk Factors",  # Label for x-axis
    y = "Count of Overdoses"  # Label for y-axis
  ) +
  theme_classic()+
  theme(
    plot.title = element_text(size = 18, hjust = 0, face = "bold"), 
    plot.subtitle = element_text(face = "italic")  ) 
```

## Cross-Validated Poisson Regression
Cross Validation tests for 2 regressions, one including just risk predictors and a second including the risk factors and the Local Moran's I spatial process features were ran .The cross validation function will use the selected variables to train a model and predict overdose incidence for each grid cell. 

```{r Selecting Variables for Goodness of Fit Metrics, message=FALSE, warning=FALSE}
reg.vars <- c("drug_calls", "vacant", "vacant.nn", "drug_calls.nn")

reg.ss.vars <- c("drug_calls", "vacant", "vacant.nn", "drug_calls.nn","overdose.isSig")
```

```{r Running Cross Validation Tests, message=FALSE, warning=FALSE, results = 'hide'}
reg.cv <- crossValidate(
  dataset = final_net,
  id = "cvID",
  dependentVariable = "countOD",
  indVariables = reg.vars) %>%
    dplyr::select(cvID = cvID, countOD, Prediction, geometry)

reg.ss.cv <- crossValidate(
  dataset = final_net,
  id = "cvID",
  dependentVariable = "countOD",
  indVariables = reg.ss.vars) %>%
    dplyr::select(cvID = cvID, countOD, Prediction, geometry)
```

## Accuracy and Generalizability
### Accuracy
To test for accuracy, mean absolute error is calculated for each fold for both regressions. After plotting the distribution of the MAE, it seems that the spatial process reduces error for our model. 

```{r Creating Goodness of Fit Metrics, message=FALSE, warning=FALSE}
reg.summary <- 
  rbind(
    mutate(reg.cv,           Error = Prediction - countOD,
                             Regression = "Random k-fold CV: Just Risk Factors"),
                             
    mutate(reg.ss.cv,        Error = Prediction - countOD,
                             Regression = "Random k-fold CV: Spatial Process")) %>%
    st_sf() 
```

```{r Plotting the Distribution of MAE for Both Regressions, message=FALSE, warning=FALSE}
error_by_reg_and_fold <- 
  reg.summary %>%
    group_by(Regression, cvID) %>% 
    summarize(Mean_Error = mean(Prediction - countOD, na.rm = T),
              MAE = mean(abs(Mean_Error), na.rm = T),
              SD_MAE = mean(abs(Mean_Error), na.rm = T)) %>%
  ungroup()

error_by_reg_and_fold %>%
  ggplot(aes(MAE)) + 
    geom_histogram(bins = 20, colour="black", fill = "#3b528b") +
    facet_wrap(~Regression) +  
    geom_vline(xintercept = 0) + scale_x_continuous(breaks = seq(0, 8, by = 1)) + 
    labs(title="Distribution of MAE",
         subtitle = "Observing the Mean Absolute Error for Random K-FOld Cross Validation Regressions",
         x="Mean Absolute Error", y="Count") +
  theme_classic()+
  theme(
    plot.title = element_text(size = 18, hjust = 0, face = "bold"), 
    plot.subtitle = element_text(face = "italic"), 
  ) 
```

The table below presents the mean MAE and the standard deviation of our MAE.The model that includes the spatial process has a lower mean MAE and lower standard deviation of the MAE, indicating this model is more accurate than the model only including risk factors
```{r Creating a Table of Our Average MAE an SD MAE, message=FALSE, warning=FALSE}
st_drop_geometry(error_by_reg_and_fold) %>%
  group_by(Regression) %>% 
    summarize(Mean_MAE = round(mean(MAE), 2),
              SD_MAE = round(sd(MAE), 2)) %>%
  kable() %>%
    kable_styling("striped", full_width = F) %>%
    row_spec(2, color = "black")
```

### Generalizability
To test for generalizability, mean error is calculated for two groups: census tracts with a median income that is greater than the median income in Cincinnati (~$45,200), and census tracts with a median income that is less than the median income in Cincinnati. The table presenting mean error for both regressions suggests that the spatial process model is more generalizable because the difference in mean error between the two income groups is lower than the difference in mean error for the model that only includes risk factors.
```{r Creating the Income Context, message=FALSE, warning=FALSE}
cincinnati_demographic_data <- cincinnati_demographic_data %>%
  mutate(incomeContext = ifelse(Median_Income > 45200, "greater_income", "lower_income"))
  
```

```{r Creating a Table to Depict Mean Error by Income Context, message=FALSE, warning=FALSE}
reg.summary %>% 
    st_centroid() %>%
    st_join(cincinnati_demographic_data) %>%
    na.omit() %>%
      st_drop_geometry() %>%
      group_by(Regression, incomeContext) %>%
      summarize(mean.Error = mean(Error, na.rm = T)) %>%
      spread(incomeContext, mean.Error) %>%
      kable(caption = "Mean Error by Income Context") %>%
        kable_styling("striped", full_width = F) 
```

## Comparing Risk Predicitions to 2022 Overdose Incidents
TO validate the model, risk predictions are compared to actual overdose incidents in 2022. Risk categories are caluclated and compared for risk predictions and overdose incidents in 2022. Referencing the map and bar chart from below, we are able to conclude that the model performs well when compared to overdose incident data from 2022. 
```{r Loading 2022 Overdose Data, message=FALSE, warning=FALSE}
overdose2022 <- read.socrata("https://data.cincinnati-oh.gov/resource/w46w-g9g7.json") %>%
  filter(!is.na(latitude_x) & !is.na(longitude_x))%>%
  filter(year(create_time_incident) == 2022) %>%
  mutate(legend = "overdose_incidents2022")
write.csv(overdose2022, file = "C:/Users/cruse/OneDrive/Desktop/PPA/overdose2022", row.names = FALSE)
rm(overdose2022)
```
```{r Transforming Overdose 2022 data,message=FALSE, warning=FALSE}
overdose2022 <- read.csv("C:/Users/cruse/OneDrive/Desktop/PPA/overdose2022") %>% 
  st_as_sf(coords = c("longitude_x", "latitude_x"), remove = FALSE) %>%
  st_set_crs('EPSG:4326') %>%
  dplyr::select(geometry, legend)

overdose2022 <- st_transform(overdose2022, crs = project_crs)%>%
  .[fishnet,]
```


```{r Calculating Risk Categories, message=FALSE, warning=FALSE}
OD_ppp <- as.ppp(st_coordinates(overdose), W = st_bbox(final_net))
OD_KD <- density.ppp(OD_ppp, 1000)

OD_KDE_sf <- as.data.frame(OD_KD) %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(final_net)) %>%
  aggregate(., final_net, mean) %>%
  mutate(label = "Kernel Density",
         Risk_Category = ntile(value, 100),
         Risk_Category = case_when(
           Risk_Category >= 90 ~ "90% to 100%",
           Risk_Category >= 70 & Risk_Category <= 89 ~ "70% to 89%",
           Risk_Category >= 50 & Risk_Category <= 69 ~ "50% to 69%",
           Risk_Category >= 30 & Risk_Category <= 49 ~ "30% to 49%",
           Risk_Category >= 1 & Risk_Category <= 29 ~ "1% to 29%")) 
OD_KDE_sf <- OD_KDE_sf %>%
  cbind(
    aggregate(
      dplyr::select(overdose2022) %>% mutate(odCount = 1), ., sum) %>%
    mutate(odCount = replace_na(odCount, 0))) %>%
  dplyr::select(label, Risk_Category, odCount)
```

```{r message=FALSE, warning=FALSE}
OD_risk_sf <-
  filter(reg.summary, Regression == "Random k-fold CV: Spatial Process") %>%
  mutate(label = "Risk Predictions",
         Risk_Category = ntile(Prediction, 100),
         Risk_Category = case_when(
           Risk_Category >= 90 ~ "90% to 100%",
           Risk_Category >= 70 & Risk_Category <= 89 ~ "70% to 89%",
           Risk_Category >= 50 & Risk_Category <= 69 ~ "50% to 69%",
           Risk_Category >= 30 & Risk_Category <= 49 ~ "30% to 49%",
           Risk_Category >= 1 & Risk_Category <= 29 ~ "1% to 29%")) 
OD_risk_sf <- OD_risk_sf %>%
  cbind(
    aggregate(
      dplyr::select(overdose2022) %>% mutate(odCount = 1), ., sum) %>%
      mutate(odCount = replace_na(odCount, 0))) %>%
  dplyr::select(label, Risk_Category, odCount)
```

```{r message=FALSE, warning=FALSE}
rbind(OD_KDE_sf, OD_risk_sf) %>%
  na.omit() %>%
  gather(Variable, Value, -label, -Risk_Category, -geometry) %>%
  ggplot() +
    geom_sf(aes(fill = Risk_Category), colour = NA) +
    geom_sf(data = sample_n(overdose2022, 3000), size = .5, colour = "black") +
    facet_wrap(~label, ) +
    scale_fill_viridis(discrete = TRUE) +
    labs(title="Comparison of Kernel Density and Risk Predictions",
         subtitle="2021 Overdose Risk Predictions; 2022 Overdose Incidents", 
         fill = "Risk Category")+
  map_theme()
```


```{r}
rbind(OD_KDE_sf, OD_risk_sf) %>%
  st_set_geometry(NULL) %>% na.omit() %>%
  gather(Variable, Value, -label, -Risk_Category) %>%
  group_by(label, Risk_Category) %>%
  summarize(countOD = sum(Value)) %>%
  ungroup() %>%
  group_by(label) %>%
  mutate(Rate_of_test_set_crimes = countOD / sum(countOD)) %>%
    ggplot(aes(Risk_Category,Rate_of_test_set_crimes)) +
      geom_bar(aes(fill=label), position="dodge", stat="identity") +
      scale_fill_manual(values = c('#5ec962', '#21918c')) +
      labs(title = "Risk prediction vs. Kernel density",
           subtitle = "Comparing Risk Predictions to 2022 Overdose Density") +
      map_theme() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5))+
  theme(
    legend.title = element_blank()
  )
```

## Locating Vending Machines
This study recommends locating vending machines with a predicted risk greater than 90% during the first phase of roll out. After collecting more data and evaluating the effectiveness of the vending machines, we recommend locating vending machines with a predicted risk greater than 70%.. 
```{r}
rbind(OD_KDE_sf, OD_risk_sf) %>%
  na.omit() %>%
  gather(Variable, Value, -label, -Risk_Category, -geometry) %>%
    filter(Risk_Category %in% c("70% to 89%", "90% to 100%")) %>% 
  ggplot() +
    geom_sf(data = boundary, fill = "darkgrey", color = alpha("white", 0)) +
    geom_sf(aes(fill = Risk_Category), colour = NA)+
    labs(title = "Recommended Vending Machine Sites in Cincinnati, Ohio",
         subtitle = "Locations with a predicted risk greater than 70%",
         fill = "Risk Category")+
    scale_fill_manual(values = c('#21918c', '#fde725')) +
    map_theme()
```

## What Could Our Model Do Better? 
Our model could be improved by adding predictors that improve generalizability. Improving this model's generalizability would equip the model to handle a diverse range of environments, and allow for the model to be adapted by other cities and organizations seeking to implement a similar program. 

## References
[1] Choi, J. I., Lee, J., Yeh, A. B., Lan, Q., & Kang, H. (2022). Spatial clustering of heroin-related overdose incidents: A case study in Cincinnati, Ohio. BMC Public Health, 22(1), 1253. https://doi.org/10.1186/s12889-022-13557-3 

[2] Centers for Disease Control and Prevention. (n.d.). Harm Reduction Vending Machines. Harm Reduction Help. Retrieved December 15, 2023, from https://harmreductionhelp.cdc.gov/s/article/Harm-Reduction-Vending-Machines

[3] Caracole. (n.d.). Safer Use Supplies. Caracole. Retrieved December 15, 2023, from https://caracole.org/safer-use-supplies/

[4]University of Cincinnati. (2022, November). UC study: Harm reduction vending machine makes impact. https://www.uc.edu/news/articles/2022/11/uc-study--harm-reduction-vending-machine-makes-impact.html

